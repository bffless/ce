# Bot/Scanner Blocklist for nginx
# Include this file in the http block of nginx.conf
#
# This blocks common vulnerability scanners looking for WordPress, Drupal,
# phpMyAdmin, and other CMS/admin tools that don't exist on this platform.
#
# Uses 444 response code which closes the connection without sending a response,
# saving bandwidth and not revealing server information to attackers.

# =============================================================================
# Path-based blocking using map (evaluated once per request, very efficient)
# =============================================================================

map $request_uri $block_scanner_path {
    default 0;

    # WordPress paths
    ~*^/wp-admin 1;
    ~*^/wp-includes 1;
    ~*^/wp-content 1;
    ~*^/wp-login 1;
    ~*^/wp-config 1;
    ~*^/wordpress 1;
    ~*^/wp/ 1;
    ~*^/blog/wp- 1;
    ~*^/site/wp- 1;
    ~*^/cms/wp- 1;

    # Drupal paths
    ~*^/sites/default 1;
    ~*^/sites/all 1;
    ~*^/drupal 1;
    ~*^/misc/drupal 1;
    ~*^/modules/ 1;
    ~*^/includes/ 1;

    # Joomla paths
    ~*^/administrator 1;
    ~*^/joomla 1;
    ~*^/components/com_ 1;

    # Magento paths
    ~*^/magento 1;
    ~*^/downloader 1;
    ~*^/skin/adminhtml 1;

    # phpMyAdmin and database tools
    ~*^/phpmyadmin 1;
    ~*^/pma 1;
    ~*^/myadmin 1;
    ~*^/mysql 1;
    ~*^/mysqladmin 1;
    ~*^/dbadmin 1;
    ~*^/sqlmanager 1;
    ~*^/mysqlmanager 1;
    ~*^/php-my-admin 1;
    ~*^/phpMyAdmin 1;
    ~*^/phpmyadmin[0-9]* 1;
    ~*^/pma[0-9]* 1;

    # Admin/management paths (generic)
    # Note: /admin/settings is a legitimate React route, so we only block specific scanner targets
    ~*^/admin\.php 1;
    ~*^/admin/config 1;
    ~*^/admin/login 1;
    ~*^/admin/index\.php 1;
    ~*^/admin/admin 1;
    ~*^/admin/includes 1;
    ~*^/admin/images/slider 1;
    ~*^/admin/fckeditor 1;
    ~*^/admin/ckeditor 1;
    ~*^/manager 1;
    ~*^/cpanel 1;
    ~*^/cPanel 1;
    ~*^/webadmin 1;
    ~*^/siteadmin 1;
    ~*^/adminpanel 1;

    # File editors
    ~*^/fckeditor 1;
    ~*^/ckeditor 1;
    ~*^/kcfinder 1;
    ~*^/editor 1;
    ~*^/filemanager 1;
    ~*^/elfinder 1;
    ~*^/tinymce 1;

    # CGI paths
    ~*^/cgi-bin 1;
    ~*^/cgi/ 1;
    ~*^/wwwroot 1;

    # Config and sensitive files (but NOT .well-known which is needed for ACME)
    ~*^/\.git 1;
    ~*^/\.svn 1;
    ~*^/\.hg 1;
    ~*^/\.env 1;
    ~*^/\.htaccess 1;
    ~*^/\.htpasswd 1;
    ~*^/\.DS_Store 1;
    ~*^/\.config 1;
    ~*^/\.aws 1;
    ~*^/\.ssh 1;
    ~*^/\.bash 1;
    ~*^/\.npm 1;
    ~*^/\.composer 1;
    ~*^/config\.php 1;
    ~*^/config\.inc 1;
    ~*^/configuration\.php 1;
    ~*^/settings\.php 1;
    ~*^/web\.config 1;
    ~*^/database\.yml 1;
    ~*^/secrets\.yml 1;

    # Backup files
    ~*^/backup 1;
    ~*^/backups 1;
    ~*^/dump 1;
    ~*^/dumps 1;
    ~*^/\.bak 1;
    ~*^/\.old 1;
    ~*^/\.orig 1;
    ~*^/\.save 1;
    ~*^/\.swp 1;
    ~*^/~$ 1;
    ~*\.sql$ 1;
    ~*\.sql\.gz$ 1;
    ~*\.sql\.zip$ 1;
    ~*\.tar\.gz$ 1;
    ~*\.tgz$ 1;
    # Note: .zip, .rar, .7z are allowed - they're legitimate assets served via /public/
    # Scanners looking for backup archives will get 404s anyway since we don't have them

    # Common exploit paths
    ~*^/shell 1;
    ~*^/c99 1;
    ~*^/r57 1;
    ~*^/cmd 1;
    ~*^/eval 1;
    ~*^/exec 1;
    ~*^/system 1;
    ~*^/console 1;
    ~*^/invoke 1;
    ~*^/debug 1;
    ~*^/test\.php 1;
    ~*^/info\.php 1;
    ~*^/phpinfo 1;
    ~*^/server-status 1;
    ~*^/server-info 1;
    ~*^/status 1;
    ~*^/jmx-console 1;
    ~*^/web-console 1;
    ~*^/axis2-admin 1;
    ~*^/axis2/ 1;
    ~*^/solr 1;
    ~*^/jenkins 1;
    ~*^/hudson 1;
    ~*^/actuator 1;
    ~*^/api-docs 1;
    ~*^/swagger 1;
    ~*^/graphql 1;
    ~*^/graphiql 1;
    ~*^/playground 1;

    # Version control web interfaces
    ~*^/\.git/config 1;
    ~*^/\.git/HEAD 1;
    ~*^/\.gitignore 1;
    ~*^/\.gitconfig 1;

    # Log files
    ~*^/logs/ 1;
    ~*^/log/ 1;
    ~*^/error\.log 1;
    ~*^/access\.log 1;
    ~*^/debug\.log 1;
    ~*\.log$ 1;

    # Other common scanner targets
    ~*^/xmlrpc\.php 1;
    ~*^/wlwmanifest\.xml 1;
    ~*^/license\.txt 1;
    ~*^/readme\.html 1;
    ~*^/readme\.txt 1;
    ~*^/changelog 1;
}

# =============================================================================
# File extension blocking (scripts that don't belong on this platform)
# =============================================================================

map $request_uri $block_scanner_extension {
    default 0;

    # Server-side scripts this platform doesn't use
    ~*\.php$ 1;
    ~*\.php[0-9]$ 1;
    ~*\.phtml$ 1;
    ~*\.asp$ 1;
    ~*\.aspx$ 1;
    ~*\.ashx$ 1;
    ~*\.asmx$ 1;
    ~*\.jsp$ 1;
    ~*\.jsf$ 1;
    ~*\.jspx$ 1;
    ~*\.cgi$ 1;
    ~*\.pl$ 1;
    ~*\.py$ 1;
    ~*\.rb$ 1;
    ~*\.lua$ 1;
    ~*\.cfm$ 1;
    ~*\.cfml$ 1;

    # Shell scripts
    ~*\.sh$ 1;
    ~*\.bash$ 1;
    ~*\.zsh$ 1;

    # Dangerous file types
    ~*\.exe$ 1;
    ~*\.dll$ 1;
    ~*\.bat$ 1;
    ~*\.cmd$ 1;
}

# =============================================================================
# Combined check - block if either path OR extension matches
# =============================================================================

map "$block_scanner_path:$block_scanner_extension" $block_scanner {
    default 0;
    "1:0" 1;
    "0:1" 1;
    "1:1" 1;
}

# =============================================================================
# Rate limiting zone for aggressive scanners (optional - use in server blocks)
# =============================================================================

# Limit request rate per IP (10 requests/second burst, then 2/sec sustained)
limit_req_zone $binary_remote_addr zone=scanner_limit:10m rate=2r/s;

# Limit connections per IP
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
